WECar 연구개발일지 (전자연구노트 시스템)
요구사항 정의서 v1.6

제품 개요

기술 스택 / 인프라

핵심 데이터 모델 (DB 스키마)

권한과 보안 정책

페이지별 상세 요구사항

5.1 인증(/auth)

5.2 사용자 대시보드(/dashboard)

5.3 내 프로필(/profile)

5.4 워크스페이스(/workspaces, /workspaces/<id>)

5.5 연구개발일지 생성(/notes/new)

5.6 연구개발일지 상세(/notes/<id>)

5.7 PDF 출력(/notes/<id>/export/pdf)

5.8 관리자(Admin) 전체(/admin …)

5.9 도움말(/help)

감사 로그(AuditLog) 표준

초기 관리자 계정 생성 방식

Cursor 구현 가이드(폴더 구조 / Blueprint / JS 등)

제품 개요

1.1 제품명
WECar 연구개발일지 (전자연구노트 시스템)

1.2 목적

연구개발 활동(실험, 테스트, 검증, 분석 등)의 “사실 그대로”를 시점과 책임자와 조건(장비/환경)과 함께 기록·보존.

정부과제 평가, 특허 분쟁, 기술이전 협상, 대외 감사에서 증빙자료로 제출 가능한 전자연구노트 수준의 신뢰성을 확보.

내부 반출(다운로드/PDF)까지 추적, 누가 어떤 자료를 외부로 내보냈는지 감사 가능하게 유지.

1.3 필수 법·운영 요건 반영

자동 타임스탬프(시점인증): 업로드 순간 서버 시간이 기록됨(timestamp_certified_at).

작성자·책임자·검토자 서명:

업로더(작성자) = 개인 식별 책임.

과제 OWNER 전자서명 = 공식 승인 책임.

REVIEWER(검토자) 전자서명 = 제3자 확인(“이 시점에 이 데이터가 실제로 있었음”).

위변조 방지:

수정은 “새 버전 업로드”로 관리 (버전 번호 증가, 기존 버전 보존).

삭제는 복구 불가 + 삭제 사유 기록 + AuditLog 남김.

장기 보관:

연구개발일지는 기본적으로 장기(수년~수십 년) 보존 대상. 삭제 전 강력 경고.

반출 추적:

파일/ PDF 다운로드는 모두 download_history와 AuditLog에 남김.

하루 다운로드 한도.

관리자 화면에서 대량 반출/지나친 접근을 경보.

PDF 워터마크:

모든 페이지에 “기밀 / 무단배포금지 / 과제명 / 생성시각 / 반출자 이메일” 워터마크.

OWNER / REVIEWER 전자서명 포함된 결재란 추가.

기술 스택 / 인프라

2.1 백엔드

Python 3.11

Flask (Blueprint 분리형 아키텍처)

gunicorn (운영 WSGI 서버)

Flask-Login (세션 기반 로그인)

CSRF 보호(Flask-WTF 또는 custom hidden token)

Rate limiting (로그인 등 민감 POST 보호)

2.2 데이터베이스

PostgreSQL 15+

장기 감사 로그, JSONB(meta_json), 검색/필터 최적화.

ORM: SQLAlchemy

마이그레이션: Alembic (버전 관리)

연결: DATABASE_URL (docker-compose 환경변수로 주입)

2.3 스토리지

/uploads/signatures/

사용자 전자서명 이미지 (민감정보)

/uploads/files/

실제 연구데이터(이미지, 로그, 측정결과, 보고서 등)

/exports/

Export된 PDF 임시 저장

직접적인 static 서빙 금지.
모든 파일/서명/PDF 접근은 Flask 라우트를 거쳐 권한·다운로드 정책 검사를 받은 후 스트림.

2.4 프론트엔드

서버렌더: Jinja2 템플릿

UI: Bootstrap 5 (반응형)

JS: Vanilla JS + 가벼운 Alpine.js 스타일 컴포넌트

Drag&Drop 업로드

태그 인라인 편집

전자서명 캔버스

폴더 순서 드래그 재정렬

삭제/위험 작업 모달

Reviewer 승인 모달

PWA 요소(Manifest + Service Worker)

로컬 임시 초안(IndexedDB/localStorage)에만 저장

자동 서버 업로드 안 함 (보안)

2.5 컨테이너 / 배포

Dockerfile (Flask+gunicorn)

docker-compose.yml

wecar-app (Flask)

wecar-db (Postgres)

컨테이너 시작 시:

alembic upgrade head

초기 관리자 계정 스크립트 실행 (아래 7장)

gunicorn 실행

system_settings.build_tag에 배포 태그 기록:

로그인 화면 하단, /admin 화면에서 표시

예: wecar-rnd:2025-10-26T12:10Z

핵심 데이터 모델 (DB 스키마)

3.1 users

id (PK)

name

email (unique)

password_hash

org_name

department

researcher_code

signature_path (전자서명 이미지 경로)

status (pending / active / suspended)

is_admin (bool)

created_at

updated_at

last_login_at

3.2 workspaces

id (PK)

name (최대 100자)

owner_user_id (FK users.id)

created_at

updated_at

3.3 workspace_members

id (PK)

workspace_id (FK workspaces.id)

user_id (FK users.id)

role (OWNER / MEMBER)

joined_at

UNIQUE(workspace_id, user_id)

3.4 research_notes (연구개발일지 = 과제 단위)

id (PK)

workspace_id (FK workspaces.id)

owner_user_id (FK users.id) // 책임자

reviewer_user_id (FK users.id, nullable)

제3자 검토자(Reviewer) 지정

title (과제명)

project_code (과제번호)

manager_name (책임자명. PDF 표지용)

start_date

end_date

allow_writer_delete (bool)

allow_member_download (bool)

deleted_at (nullable)

created_at

updated_at

3.5 research_note_members

id (PK)

note_id (FK research_notes.id)

user_id (FK users.id)

role (OWNER / WRITER / READER / REVIEWER)

REVIEWER: 업로드권한 없이 열람+검토서명 가능

created_at

UNIQUE(note_id, user_id)

3.6 folders (연구일지 내 목차/섹션)

id (PK)

note_id (FK research_notes.id)

name (<= 50자)

order_index (int) // 목차 순서

created_at

updated_at

deleted_at (nullable)

3.7 files

id (PK)

note_id (FK research_notes.id)

folder_id (FK folders.id)

uploader_user_id (FK users.id)

original_filename

display_name

stored_filename (uuid.ext)

mime_type

size_bytes

created_date (실제 실험/테스트 수행일)

uploaded_at (업로드 시각)

timestamp_certified_at (업로드 순간 서버 시각, 시점인증)

version_number (int, default=1)

overwrite 금지. 새 버전은 새 row로 version_number+1

is_deleted (bool)

3.8 file_tags

id (PK)

file_id (FK files.id ON DELETE CASCADE)

tag (varchar(64))

UNIQUE(file_id, tag)

3.9 download_history

id (PK)

note_id (FK research_notes.id)

file_id (FK files.id nullable) // PDF Export일 때 null

user_id (FK users.id)

download_type (RAW_FILE | PDF_EXPORT)

created_at

3.10 audit_logs

id (PK)

user_id (FK users.id)

workspace_id (FK workspaces.id nullable)

note_id (FK research_notes.id nullable)

file_id (FK files.id nullable)

action_type (text)

예: USER_REGISTER, USER_LOGIN, FILE_UPLOAD, FILE_VERSION_UP, FILE_DELETE,
NOTE_SETTINGS_UPDATE, NOTE_MEMBER_UPDATE, NOTE_TRANSFER_OWNER,
REVIEWER_APPROVE, NOTE_DELETE,
ADMIN_USER_STATUS_CHANGE, ADMIN_NOTE_SETTINGS_FORCE,
NOTE_PDF_EXPORT, FILE_DOWNLOAD, FILE_DOWNLOAD_DENIED …

meta_json (JSONB; IP, 이전/이후 role, change_reason, 삭제 사유, old_owner→new_owner 등)

created_at

3.11 system_settings

key (PK text)

value (text/json)

allowed_extensions → ".pdf,.jpg,.png,.csv,.xlsx,.zip"

max_file_size_mb → "500"

daily_download_limit → "100"

session_timeout_min → "30"

build_tag → "wecar-rnd:2025-10-26T12:10Z"

권한과 보안 정책

4.1 사용자 상태

status=='active'만 로그인 가능

Admin이 /admin/users에서 pending→active (승인) 또는 active→suspended (정지)

이런 변경 자체도 감사 로그에 남김 (ADMIN_USER_STATUS_CHANGE)

4.2 연구일지 역할과 권한

OWNER

일지 설정 변경(다운로드 정책 등)

멤버/역할 관리

소유권 이전

일지 삭제(영구, 위험)

PDF Export 요청/다운로드

모든 파일/폴더 삭제 가능

Reviewer에게 승인 요청 가능

WRITER

Drag&Drop 업로드

폴더 생성/수정/순서변경

파일명/태그 수정

파일 폴더 이동

allow_writer_delete=true 이면 파일 삭제 가능

allow_member_download=true 이면 파일/PDF 다운로드 가능

READER

열람/검색

allow_member_download=true 이면 다운로드 가능

업로드/삭제 불가

REVIEWER

열람 가능 (READER 이상)

승인/검토 서명 남김(/notes/<id>/approve)

“이 시점에 기록된 데이터가 존재함”을 확인해주는 제3자 서명

업로드/삭제 불가

4.3 다운로드 / 반출 제어

WRITER/READER/REVIEWER가 다운로드/PDF Export 하려면

note.allow_member_download == true

개인별 “오늘 다운로드 횟수” < daily_download_limit

허용 시:

download_history INSERT

AuditLog("FILE_DOWNLOAD" 또는 "NOTE_PDF_EXPORT")

차단 시:

AuditLog("FILE_DOWNLOAD_DENIED" / "FILE_DOWNLOAD_LIMIT_BLOCKED")

HTTP 403

/admin/downloads에서 관리자 모니터링

24시간 TOP5 반출자

50건 이상 대량 반출 경보

suspended 계정의 접근 시도 등

4.4 위변조 방지 / 시점인증

파일 업로드 시 timestamp_certified_at 자동 기록 (서버 now())

AuditLog("FILE_UPLOAD",{timestamp_certified_at,...})

파일 수정은 “새 버전 업로드”

version_number 증가

change_reason 필수

AuditLog("FILE_VERSION_UP",{old_version,new_version,change_reason})

삭제는 복구 불가

삭제 사유(reason) 필수

실파일 삭제 + is_deleted=true

AuditLog("FILE_DELETE",{reason})

삭제 전 경고: “연구노트는 장기 보존 의무 대상입니다. 삭제는 법적 증빙력을 약화시킬 수 있습니다.”

노트 삭제도 비슷하게 강력 경고 + 삭제 사유 기록 + AuditLog("NOTE_DELETE")

4.5 승인/서명 플로우

각 사용자(OWNER/REVIEWER)는 /profile에서 전자서명 이미지를 등록

/notes/<id>/approve (POST):

OWNER 또는 REVIEWER가 승인/검토 서명

서버: 서명자 ID, 역할(OWNER/REVIEWER), 서명 시각(signed_at), 해당 시점의 signature_path를 snapshot해서 저장

AuditLog("REVIEWER_APPROVE",{role:'OWNER'/'REVIEWER',signed_at})

PDF 내 결재란:

OWNER 전자서명 + 승인일시

REVIEWER 전자서명 + 확인일시(있으면)

워터마크(기밀 / 무단배포금지 / 과제명 / 생성시각 / 반출자 이메일)를 모든 페이지에 삽입

페이지별 상세 요구사항

5.1 인증 (/auth)

[UI]

상단: WECar 로고 + 현재 build_tag (작은 회색 텍스트)

탭 전환:

로그인 탭

이메일

비밀번호

[로그인] 버튼

안내:

“비밀번호 분실 시 관리자에게 문의”

“공용PC 사용 후 반드시 로그아웃”

회원가입 탭

이름

이메일

비밀번호 / 비밀번호확인

소속(org_name)

부서/전공(department)

연구자번호(researcher_code)

전자서명 등록(서명 캔버스 or 이미지 업로드 미리보기)

[내 워크스페이스 자동 생성] 체크

체크 시 워크스페이스명 입력

[가입 신청] 버튼

가입 직후: “승인 대기 상태입니다(pending). 관리자 승인 후 로그인 가능합니다.”

[백엔드]

POST /auth/register

users INSERT(status='pending')

signature_path 저장(/uploads/signatures/...)

create_workspace 체크 시

workspaces INSERT

workspace_members INSERT(current_user as OWNER)

AuditLog("USER_REGISTER")

POST /auth/login

이메일/비번 검사(bcrypt)

status=='active'만 통과

last_login_at 갱신

세션(Flask-Login)

AuditLog("USER_LOGIN")

suspended/pending이면 차단 + AuditLog("USER_LOGIN_DENIED",{reason})

GET /logout

[보안]

CSRF 토큰

Rate limiting (로그인 시도)

HTTPS 가정

session_timeout_min은 system_settings에서 불러와 세션 만료에 반영

5.2 사용자 대시보드 (/dashboard)

[UI 구성 카드]

내 워크스페이스

드롭다운: 내가 속한 워크스페이스

멤버수, Owner 표시

[워크스페이스로 이동] 버튼

내 연구과제(연구개발일지)

과제명(title)

내 역할(OWNER/WRITER/READER/REVIEWER)

승인 상태 뱃지:

“검토자 서명 완료”

“검토 대기”
(Reviewer 승인/OWNER 승인 AuditLog 최신값 기준)

최근 업로드된 파일의 실제 실험일(created_date)

최근 업로드(내가 업로드한 최신 5개 파일)

파일명(display_name)

속한 과제명

created_date (실험일)

uploaded_at

최근 다운로드(내 다운로드 이력 5건)

대상(파일명 or “PDF Export”)

다운로드 시각

“오늘 n/제한 m” 표시

최근 활동 로그(내 접근 가능한 노트의 AuditLog 상위 10건)

아이콘별로 FILE_UPLOAD, FILE_VERSION_UP, FILE_DELETE, REVIEWER_APPROVE 등 표시

경고/알림

“당신이 OWNER인 과제 중 Reviewer 승인(검토 서명) 없음”

“전자서명 미등록 → PDF 승인 불가”

“다운로드 한도 근접”

[백엔드]

GET /dashboard

DB 조회:

workspaces JOIN workspace_members (현재 유저)

research_notes JOIN research_note_members (현재 유저)

각 노트별 마지막 REVIEWER_APPROVE/OWNER 승인 로그 시간

files WHERE uploader_user_id=current_user ORDER BY uploaded_at DESC LIMIT 5

download_history WHERE user_id=current_user ORDER BY created_at DESC LIMIT 5

audit_logs WHERE note_id IN (내가 속한 노트들) ORDER BY created_at DESC LIMIT 10

권한: 로그인 + status=='active'

5.3 내 프로필 (/profile)

[UI]

내 정보: 이름, 이메일, org_name, department, researcher_code, status, last_login_at

전자서명 미리보기

“서명 등록됨” 혹은 “서명 없음 (PDF에서 빈칸 처리됨)” 경고 배지

[전자서명 다시 등록] 버튼

모달: 캔버스 서명 저장 or 이미지 업로드

비밀번호 변경 섹션

현재 비밀번호

새 비밀번호 / 확인

[변경] 버튼

경고 배지:

“Owner 서명 미등록 → PDF 책임자 서명란 비어 있음”

“Reviewer 서명 미등록 → 검토 서명 불가”

[백엔드]

GET /profile

POST /profile/update

org_name, department, researcher_code 변경

AuditLog("PROFILE_UPDATE")

POST /profile/password

bcrypt 확인 후 변경

AuditLog("PASSWORD_CHANGE")

POST /profile/signature

signature_path 교체

AuditLog("SIGNATURE_UPDATE")

[보안]

민감 경로(/uploads/signatures)는 직접 URL 액세스 금지

전자서명 이미지는 PDF 렌더링 등 내부 용도로만 사용

5.4 워크스페이스 (/workspaces, /workspaces/<id>)

[목록 화면 /workspaces]

카드 리스트:

워크스페이스명

Owner 이름

멤버 수

과제(노트) 수

열기

[+ 새 워크스페이스] 버튼

모달에서 이름 입력 → 생성

[상세 화면 /workspaces/<id>]
A. 워크스페이스 정보

워크스페이스명

Owner

생성일

멤버수

B. 멤버 관리 테이블

각 멤버: 이름 / 이메일 / role(OWNER/MEMBER)

Owner만:

role 변경 드롭다운

멤버 제거

“멤버 초대” 입력창 (이메일로 사용자 검색해서 추가)

C. 이 워크스페이스의 연구과제(연구노트) 목록

과제명(title)

Owner

Reviewer 지정 여부

내 권한(OWNER/WRITER/READER/REVIEWER)

폴더(목차) 개수

최근 업로드 시각

열기

+ 새 연구개발일지 만들기

[백엔드]

GET /workspaces

POST /workspaces

새 workspace 생성

workspace_members에 현재 유저 OWNER로 등록

AuditLog("WORKSPACE_CREATE")

GET /workspaces/<id>

접근: workspace_members.user_id == current_user.id

POST /workspaces/<id>/invite

Owner만

workspace_members INSERT

AuditLog("WORKSPACE_INVITE")

POST /workspaces/<id>/member-role

Owner만

역할 변경/제거

AuditLog("WORKSPACE_MEMBER_CHANGE")

5.5 연구개발일지 생성 (/notes/new)

[UI - Step1 기본정보]

워크스페이스 선택(현재 내가 참여 중인 것만)

과제명(title)

과제번호(project_code)

책임자명(manager_name)

기간(start_date~end_date) (+3개월/+6개월 자동 채움 버튼)

PDF 표지 미리보기 카드

[UI - Step2 보안/정책]

체크박스:

“WRITER도 파일 삭제 가능” (allow_writer_delete)

경고: 삭제는 복구 불가/장기보존 의무 주의

“멤버도 직접 다운로드 허용” (allow_member_download)

경고: 다운로드=반출, 모든 반출은 감시 기록

일일 다운로드 한도(daily_download_limit) 정보 표시(읽기 전용)

[UI - Step3 참여자 권한]

워크스페이스 멤버 목록

각 멤버에 대해 역할 선택:

OWNER / WRITER / READER / REVIEWER

최소 OWNER는 1명 필수

REVIEWER 0명도 가능하지만 있으면 이후 PDF에 검토자 서명 영역 활성

[연구개발일지 생성] 버튼

[백엔드]

GET /notes/new

POST /notes

research_notes INSERT(owner_user_id, reviewer_user_id(선택), allow_writer_delete, allow_member_download 등)

research_note_members INSERT(각 인원/역할)

AuditLog("NOTE_CREATE")

[권한]

워크스페이스 OWNER 또는 정책적으로 허용된 멤버만 생성 가능

5.6 연구개발일지 상세 (/notes/<id>)

(1) 헤더 섹션

과제명(title) / 과제번호(project_code) / 기간(start_date~end_date)

책임자명(manager_name)

정책 뱃지:

“멤버 다운로드 허용/차단”

“작성자 삭제 허용/금지”

멤버 요약:

OWNER / WRITER / READER / REVIEWER 그룹 칩

hover 시: org_name, researcher_code, 서명 등록 여부

OWNER 또는 REVIEWER 서명 미등록 시 빨간 아이콘

승인 상태:

마지막 OWNER 승인 시각

마지막 REVIEWER 검토 서명 시각

상태 배지 (“검토자 서명 완료” / “검토 대기”)

OWNER 전용 액션 버튼:

[PDF 출력] (/notes/<id>/export/pdf)

[일지 설정 변경] (/notes/<id>/settings)

[멤버/권한 관리] (/notes/<id>/members)

[검토자 승인 요청] (Reviewer에게 승인 요청 모달)

[소유권 이전] (/notes/<id>/transfer-ownership)

[일지 삭제] (강력 경고 모달: “장기 보존 의무. 삭제 시 법적 증빙력 상실 가능”)

(2) 좌측 패널 = 폴더(목차)

폴더 목록은 order_index 순서

[+ 새 폴더] (OWNER/WRITER만)

폴더명 인라인 수정

드래그&드롭으로 순서 재정렬 → /folders/reorder

폴더 삭제(OWNER/WRITER 가능 여부는 정책에 따름)

“삭제 사유” 필수

하위 파일 전부 삭제 처리

AuditLog("FOLDER_DELETE")

(3) 우측 패널 = 파일 리스트
상단 바:

Drag&Drop 업로드 영역

DnD 시 업로드 모달:

files[]

created_date (실험 수행일, 필수)

short_desc (핵심 목적/조건)

tags ("태그1,태그2,...")

[업로드 실행]

업로드 완료 시:

timestamp_certified_at=now()

AuditLog("FILE_UPLOAD",{short_desc,created_date,timestamp_certified_at})

“파일 추가” 버튼(동일 모달 트리거)

검색(q)

작성일(실험일) 기간 필터(from~to)

태그 필터

보기 전환(리스트/썸네일)

파일 리스트(리스트 뷰):

display_name (인라인 수정 가능)

version_number (v1/v2/v3…)

created_date (실제 수행일)

업로더(작성자+researcher_code)

tags chip

timestamp_certified_at (아이콘 + tooltip: “이 시점에 존재 인증”)

옵션 (…) 드롭다운:

다운로드

이름 변경 (/files/<id>/rename)

태그 수정 (/files/<id>/tags)

폴더 이동 (/files/<id>/move)

새 버전 업로드 (/files/<id>/new-version)

file + change_reason 필수

AuditLog("FILE_VERSION_UP",{old_version,new_version,change_reason})

기존 버전은 삭제 안 하고 보존

삭제

OWNER 또는 (WRITER && allow_writer_delete==true)

삭제 사유(reason) 필수

실제 파일 삭제 + is_deleted=true

AuditLog("FILE_DELETE",{reason})

하단 탭:

[활동 로그]

AuditLog 타임라인 뷰

주요 이벤트(FILE_UPLOAD, FILE_VERSION_UP, FILE_DELETE, NOTE_SETTINGS_UPDATE, NOTE_TRANSFER_OWNER, REVIEWER_APPROVE 등)

CSV Export 버튼(OWNER/Admin만)

[다운로드 이력]

download_history 최근 내역

컬럼:

시각

사용자

대상(파일명 or "PDF Export")

download_type

24시간 내 50건 이상 다운로드한 사용자에 빨간 경고 아이콘

(4) 관련 백엔드 라우트

GET /notes/<id> (렌더)

POST /notes/<id>/settings (OWNER)

allow_writer_delete / allow_member_download 업데이트

AuditLog("NOTE_SETTINGS_UPDATE")

POST /notes/<id>/members (OWNER)

멤버 역할(OWNER/WRITER/READER/REVIEWER) 수정

AuditLog("NOTE_MEMBER_UPDATE")

POST /notes/<id>/transfer-ownership (OWNER)

Owner 변경

AuditLog("NOTE_TRANSFER_OWNER")

POST /notes/<id>/approve (OWNER or REVIEWER)

승인/검토 서명 등록

서버에서 approver의 signature_path+timestamp snapshot

AuditLog("REVIEWER_APPROVE",{approver_role:'OWNER'/'REVIEWER',signed_at})

DELETE /notes/<id> (OWNER)

강력 경고 + 삭제 사유

note.deleted_at 설정

관련 파일 정리

AuditLog("NOTE_DELETE",{reason})

GET /notes/<id>/audit (JSON) // note 멤버만

GET /notes/<id>/downloads (JSON) // note 멤버만

폴더/파일 Ajax:

POST /notes/<note_id>/folders

name

OWNER/WRITER

AuditLog("FOLDER_CREATE")

POST /folders/<id>/rename

OWNER/WRITER

AuditLog("FOLDER_RENAME")

POST /folders/reorder

OWNER/WRITER

AuditLog("FOLDER_REORDER")

DELETE /folders/<id>

OWNER/WRITER (정책 허용 시)

삭제 사유 필수

AuditLog("FOLDER_DELETE",{reason})

POST /folders/<folder_id>/files

multipart: files[], created_date(필수), short_desc, tags

OWNER/WRITER

timestamp_certified_at=now()

AuditLog("FILE_UPLOAD")

POST /files/<file_id>/new-version

multipart: file + change_reason(필수)

OWNER/WRITER

새 row version_number=old+1

AuditLog("FILE_VERSION_UP",{change_reason})

POST /files/<file_id>/rename

OWNER/WRITER

AuditLog("FILE_RENAME")

POST /files/<file_id>/tags

OWNER/WRITER

AuditLog("FILE_TAG_UPDATE")

POST /files/<file_id>/move

OWNER/WRITER

AuditLog("FILE_MOVE")

GET /files/<file_id>/download

OWNER: 항상 허용

WRITER/READER/REVIEWER:

note.allow_member_download == true

다운로드 한도 미초과

성공 시:

download_history INSERT(download_type="RAW_FILE")

AuditLog("FILE_DOWNLOAD")

실패 시:

AuditLog("FILE_DOWNLOAD_DENIED"/"FILE_DOWNLOAD_LIMIT_BLOCKED")

403

DELETE /files/<file_id>

OWNER or (WRITER && allow_writer_delete==true)

삭제 사유 필수

실제 삭제 + is_deleted=true

AuditLog("FILE_DELETE",{reason})

5.7 PDF 출력 (/notes/<id>/export/pdf)

[기능 목적]

외부 제출(정부평가/감사/기술이전/특허 분쟁 등)에 제출 가능한 공식 문서 생성

[PDF 구성 요소]

모든 페이지 워터마크

“WECar 연구개발일지 / {과제명} / 기밀 / 무단배포금지 / {PDF생성일시} / {다운로드 사용자 이메일}”

하단 푸터: “이 문서는 반출 기록됩니다. 무단 전파 금지.”

표지

과제명 / 과제번호 / 책임자(manager_name)

기간(start_date~end_date)

PDF 생성일시

참여자 & 역할표

OWNER / WRITER / READER / REVIEWER

각자 소속(org_name), researcher_code

연구 기록 인덱스

display_name

created_date(실제 수행일)

업로더(작성자)

tags(장비/조건/샘플ID 등)

version_number

timestamp_certified_at (시점인증)

short_desc(실험 목적/핵심 조건)

최근 핵심 AuditLog 요약

FILE_UPLOAD (언제 누가 올렸는가)

FILE_VERSION_UP (변경 사유)

FILE_DELETE (삭제 사유)

NOTE_SETTINGS_UPDATE

NOTE_TRANSFER_OWNER

REVIEWER_APPROVE (승인/검토 서명)

시간순 정렬

목적: “누가 / 언제 / 무엇을 / 왜 바꿨는지” 외부 감사에 바로 제출 가능

승인/서명(결재란)

OWNER:

이름 / 직함(or org_name)

전자서명 이미지(signature_path 스냅샷)

승인일시(now)

선언문:
“본인은 본 연구개발일지의 내용이 해당 시점에 실제 수행·관찰된 결과임을 확인하며, 그 진실성과 성실성을 보증합니다.”

REVIEWER(있으면):

이름 / 소속

전자서명 이미지

확인일시(now)

선언문:
“본인은 명시된 시점에 이 기록이 존재했음을 확인합니다 (검토자/제3자 확인).”

[백엔드 플로우]

GET /notes/<id>/export/pdf

권한:

OWNER → 항상 OK

WRITER/READER/REVIEWER:

note.allow_member_download == true

하루 다운로드 한도 미초과

동작:

note 메타, 멤버/권한표, 파일 인덱스, 최근 AuditLog 주요 이벤트, OWNER/REVIEWER 승인 정보 조회

export_pdf.html 렌더 → wkhtmltopdf 또는 WeasyPrint

워터마크/푸터 삽입

/exports/<note_id>-<timestamp>.pdf로 임시 저장

download_history INSERT(download_type="PDF_EXPORT")

AuditLog("NOTE_PDF_EXPORT",{note_id,user_id})

send_file() 스트림 응답

5.8 관리자(Admin) 전체 (/admin ...)

5.8.1 /admin (관리자 대시보드)
[UI]

카드:

활성 사용자 수 / 신규가입(pending) 수

활성 워크스페이스 수

활성 연구과제 수

오늘 업로드된 파일 수

오늘 다운로드(반출) 수

보안/리스크:

최근 24시간 다운로드 TOP5 (횟수 포함)

하루 50건 이상 다운로드한 사용자 (빨간 경고)

suspended 계정 로그인 시도

allow_member_download=false인데 WRITER/READER/REVIEWER가 다운로드 시도→차단된 이벤트

운영 리스크:

"최근 30일 업로드 0건" 과제 목록

과제명 / Owner / 마지막 업로드 시각

형식적 운영(사후 몰아쓰기) 의심

품질:

Reviewer 없는 과제

Reviewer는 있으나 REVIEWER_APPROVE(검토 서명)이 한 번도 없는 과제

제3자 확인 부재 경고

시스템 정보:

system_settings.build_tag

Alembic head version

현재 서버 시간

접근 시 AuditLog("ADMIN_DASHBOARD_VIEW")

권한:

login_required && current_user.is_admin == True

5.8.2 /admin/users
[UI]

검색(이름/이메일)

테이블:

이름 / 이메일 / org_name / researcher_code

status(pending/active/suspended) [드롭다운]

is_admin [체크박스]

마지막 로그인

서명 등록 여부(없으면 경고 아이콘: “이 사용자가 Owner라면 PDF 서명 누락 위험”)

status 변경 / is_admin 토글 시 실시간 Ajax

[백엔드]

GET /admin/users

POST /admin/users/<id>/status

status 변경 (pending→active 등)

AuditLog("ADMIN_USER_STATUS_CHANGE",{user_id,old_status,new_status})

POST /admin/users/<id>/admin

is_admin 토글

AuditLog("ADMIN_TOGGLE_ADMIN",{target_user_id,is_admin})

(선택) 비밀번호 강제 초기화 시 AuditLog("ADMIN_FORCE_PASSWORD_RESET")

5.8.3 /admin/workspaces
[UI]

워크스페이스 테이블:

이름 / Owner / 멤버수 / 생성일

[자세히] 모달:

멤버 목록(이름/이메일/role)

관리자 강제 role 변경 / 강제 제거 가능

AuditLog("ADMIN_WORKSPACE_MEMBER_CHANGE")

[백엔드]

GET /admin/workspaces

POST /admin/workspaces/<id>/member-role

AuditLog("ADMIN_WORKSPACE_MEMBER_CHANGE")

5.8.4 /admin/notes
[UI]

연구과제(노트) 리스트:

과제명 / Owner / workspace

allow_member_download / allow_writer_delete

파일 수 / 총 용량 / 최근 업로드 시각

Reviewer 지정 여부 / 최근 REVIEWER_APPROVE 시각

deleted 여부

경고:

“최근 30일 업로드 0건”

“검토자 승인 없음”

[자세히] 모달:

멤버/역할표(OWNER/WRITER/READER/REVIEWER)

강제 정책 변경:

POST /admin/notes/<id>/force-settings

allow_member_download 등 강제로 on/off

AuditLog("ADMIN_NOTE_SETTINGS_FORCE")

Owner 강제 이전:

POST /admin/notes/<id>/force-transfer-owner

AuditLog("ADMIN_NOTE_FORCE_OWNER_TRANSFER")

[백엔드]

GET /admin/notes

POST /admin/notes/<id>/force-settings

POST /admin/notes/<id>/force-transfer-owner

5.8.5 /admin/audit
[UI]

필터:

기간(from/to)

action_type

user email

note_id

workspace_id

결과 테이블:

timestamp

user (이름/이메일)

action_type

meta_json 요약 (삭제 사유 등 핵심 정보)

Export CSV 버튼

접근 자체 AuditLog("ADMIN_VIEW_AUDIT",{filters})

관리자의 열람도 추적해서 내부 남용 방지

[백엔드]

GET /admin/audit

5.8.6 /admin/downloads
[UI]

다운로드/반출 이력 테이블:

시간

사용자

과제명

대상(파일명 or “PDF Export”)

download_type

“24시간 다운로드 TOP5”

“한도 초과 시도(차단)” 목록

접근 시 AuditLog("ADMIN_VIEW_DOWNLOADS")

[백엔드]

GET /admin/downloads

5.8.7 /admin/settings
[UI]

허용 확장자(allowed_extensions)

최대 파일 크기(max_file_size_mb)

하루 다운로드 한도(daily_download_limit)

세션 타임아웃(session_timeout_min)

build_tag (읽기 전용)

[저장] 버튼

[백엔드]

GET /admin/settings

POST /admin/settings

system_settings UPDATE

AuditLog("ADMIN_UPDATE_SETTINGS",{changed_keys})

[보안 공통]

모든 /admin/* 라우트:

login_required

current_user.is_admin == True 아니면 403

거부 자체도 AuditLog("ADMIN_ACCESS_DENIED",{route,user})

5.9 도움말 (/help)

이 페이지는 실제 사용자 교육용. GitHub 등 불필요 문서 제거하고 핵심만.

섹션 구성:

왜 이 시스템을 써야 하나?

전자연구노트는 연구의 “사실기록”이며 정부평가, 특허, 분쟁 방어, 기술이전 협상 핵심 증거.

사후 몰아쓰기/누락은 신뢰도를 크게 떨어뜨리고 문제가 된다.

무엇을 기록해야 하나?

실제 실험일(created_date)

목적/조건/장비(온도, 전압, SW버전 등)

절차(누가 어떤 순서로 했는지)

결과(성공/실패 모두)

문제점/해석

책임자(OWNER) 및 제3자(Reviewer)의 승인 흔적

어떻게 기록하나?

실험 직후 Drag&Drop 업로드

업로드 폼에서 실험일(created_date), 핵심조건(short_desc), 태그(장비, 샘플ID 등) 꼭 입력

수정은 “새 버전 업로드”로 하고 예전 버전은 남겨둔다 (이력 보존)

삭제는 최후 수단 (복구 불가능, 감사 대상)

누가 볼 수 있나?

OWNER / WRITER / READER / REVIEWER만

OWNER가 허용하지 않으면 다운로드 불가

모든 다운로드는 반출로 기록되고 관리자가 본다

언제 PDF로 뽑나?

평가/감사/외부 제출 시

PDF에는 과제정보, 참여자 권한표, 실험 기록 인덱스(시점인증 포함), 최근 핵심 Audit 로그, OWNER 서명, REVIEWER 서명(있을 경우), 워터마크가 포함된다

보안 주의

PDF나 파일을 외부로 전달하면 곧바로 반출 이력에 남는다

일일 다운로드 한도 초과 시 차단된다

계정 공유 금지: 모든 업로드/다운로드/승인은 개인 계정으로 AuditLog에 남는다

감사 로그(AuditLog) 표준

모든 중요한 행위는 AuditLog에 남는다. meta_json에는 사유/변경 전후 정보/시점 등을 반드시 기록.

주요 action_type 예시:

USER_REGISTER

USER_LOGIN / USER_LOGIN_DENIED

PROFILE_UPDATE / SIGNATURE_UPDATE / PASSWORD_CHANGE

WORKSPACE_CREATE / WORKSPACE_INVITE / WORKSPACE_MEMBER_CHANGE

NOTE_CREATE

NOTE_SETTINGS_UPDATE

NOTE_MEMBER_UPDATE

NOTE_TRANSFER_OWNER

NOTE_DELETE

REVIEWER_APPROVE (승인/검토 서명)

FILE_UPLOAD

FILE_VERSION_UP (change_reason 포함)

FILE_RENAME / FILE_TAG_UPDATE / FILE_MOVE

FILE_DELETE (삭제 사유 포함)

FILE_DOWNLOAD / FILE_DOWNLOAD_DENIED / FILE_DOWNLOAD_LIMIT_BLOCKED

NOTE_PDF_EXPORT

ADMIN_USER_STATUS_CHANGE

ADMIN_TOGGLE_ADMIN

ADMIN_WORKSPACE_MEMBER_CHANGE

ADMIN_NOTE_SETTINGS_FORCE

ADMIN_NOTE_FORCE_OWNER_TRANSFER

ADMIN_VIEW_AUDIT / ADMIN_VIEW_DOWNLOADS / ADMIN_DASHBOARD_VIEW

ADMIN_ACCESS_DENIED

ADMIN_UPDATE_SETTINGS

이 감사 로그는:

/notes/<id>/audit 탭에서 노트 단위 요약 확인

/admin/audit에서 전체 검색/필터/CSV 내보내기 가능

초기 관리자 계정 생성 방식

운영 시 비밀번호 하드코딩은 금지지만, 개발/테스트용 초기 관리자 2계정은 자동 생성하도록 한다.

.env 예시:

ADMIN1_EMAIL=jty9410@wecar-m.co.kr
ADMIN1_PASSWORD=#jeong07209

ADMIN2_EMAIL=wecar@wecar-m.co.kr
ADMIN2_PASSWORD=#wecarm1004


초기화 스크립트 app/scripts/init_admin.py:

Flask app context로 DB 접속

위 두 계정을 users 테이블에 삽입(없을 경우에만)

name, org_name, department은 적절히 기본값 세팅

password_hash = bcrypt(hash)

status='active'

is_admin=True

각 생성 시 콘솔에 “Created admin: {email}”

커밋 후 종료

docker-compose의 app 서비스 기동 command 흐름:

flask db upgrade (alembic)

python app/scripts/init_admin.py

gunicorn -b 0.0.0.0:8000 app:app

이 방식으로:

jty9410@wecar-m.co.kr
 / #jeong07209

wecar@wecar-m.co.kr
 / #wecarm1004
두 계정이 status='active', is_admin=True 상태로 초기 세팅된다.

주의:

운영환경 전환 시 이 스크립트 또는 .env는 제거/무력화하고 관리자 비밀번호를 교체해야 한다.

관리자 로그인 성공도 AuditLog("USER_LOGIN")로 남고, /admin 접근은 AuditLog("ADMIN_DASHBOARD_VIEW") 등으로 모두 추적된다.

Cursor 구현 가이드

8.1 디렉토리 구조(예시)

app/
  __init__.py
  models/
    __init__.py
    user.py
    workspace.py
    note.py
    folder.py
    file.py
    audit.py
    system_settings.py
  blueprints/
    auth.py
    dashboard.py
    profile.py
    workspaces.py
    notes.py
    folders.py
    files.py
    export.py
    admin.py
    help.py
  scripts/
    init_admin.py
templates/
  auth.html
  dashboard.html
  profile.html
  workspaces.html
  workspace_detail.html
  notes_new.html
  note_detail.html
  admin_dashboard.html
  admin_users.html
  admin_workspaces.html
  admin_notes.html
  admin_audit.html
  admin_downloads.html
  admin_settings.html
  help.html
  export_pdf.html
static/
  css/...
  js/
    signature.js
    upload.js
    tags.js
    reorder_folders.js
    approve.js
    delete_confirm.js
    download_guard.js
uploads/
  signatures/
  files/
exports/
alembic/
docker-compose.yml
Dockerfile
.env


8.2 Blueprint별 책임

auth.py
/auth (GET 렌더), /auth/login (POST), /auth/register (POST), /logout

dashboard.py
/dashboard (GET)

profile.py
/profile (GET), /profile/update (POST), /profile/password (POST), /profile/signature (POST)

workspaces.py
/workspaces (GET, POST), /workspaces/<id> (GET), /workspaces/<id>/invite (POST), /workspaces/<id>/member-role (POST)

notes.py
/notes/new (GET/POST)
/notes/<id> (GET)
/notes/<id>/settings (POST)
/notes/<id>/members (POST)
/notes/<id>/transfer-ownership (POST)
/notes/<id>/approve (POST)
/notes/<id> (DELETE)
/notes/<id>/audit (GET JSON)
/notes/<id>/downloads (GET JSON)

folders.py
/notes/<note_id>/folders (POST)
/folders/<id>/rename (POST)
/folders/reorder (POST)
/folders/<id> (DELETE)

files.py
/folders/<folder_id>/files (POST)
/files/<file_id>/new-version (POST)
/files/<file_id>/rename (POST)
/files/<file_id>/tags (POST)
/files/<file_id>/move (POST)
/files/<file_id>/download (GET)
/files/<file_id> (DELETE)

export.py
/notes/<id>/export/pdf (GET)

admin.py
/admin (GET)
/admin/users (GET)
/admin/users/<id>/status (POST)
/admin/users/<id>/admin (POST)
/admin/workspaces (GET)
/admin/workspaces/<id>/member-role (POST)
/admin/notes (GET)
/admin/notes/<id>/force-settings (POST)
/admin/notes/<id>/force-transfer-owner (POST)
/admin/audit (GET)
/admin/downloads (GET)
/admin/settings (GET/POST)

help.py
/help (GET)

8.3 공통 처리

LoginRequired + status=='active' 미충족 시 접근 불가

AdminRequired(current_user.is_admin==True) 필터

모든 민감 요청(설정 변경, 삭제, 소유권 이전, 승인/서명 등)은 AuditLog에 action_type과 meta_json(reason, old→new 등)을 남긴다.

파일 다운로드/ PDF Export는 download_history INSERT + AuditLog 기록

PDF Export는 워터마크/서명/승인일시/감사 요약 포함

최종 한마디

이 요구사항 정의서 v1.6은 다음을 보장합니다:

각 페이지별로 UI 요소, 입력 필드, 동작 플로우, 권한 제어, 서버 라우트, 감사 로그 액션이 모두 명시되어 있음.

전자연구노트 필수 요건(시점인증, 책임자 서명, 제3자 검토자 서명, 변경 이력/삭제 사유 보존, 장기보존 전제, 반출 추적, 워터마크 추적성)을 시스템 전반에 반영.

Docker/Alembic까지 포함한 실제 배포 흐름, 초기 관리자 계정 세팅 흐름, 빌드 태그 관리까지 명확.

이 문서를 기반으로 Cursor에서 바로 모델/마이그레이션/블루프린트/템플릿/JS를 생성하면 WECar 연구개발일지(전자연구노트 시스템)를 일관된 방식으로 구현할 수 있습니다.

WECar 연구개발일지 요구사항 정의서 v1.7 (보완판)

핵심 신규 보완 포인트

전역 보안/운영 요구사항 보강

페이지별 추가 요구/개선

로그인/회원가입

대시보드

연구과제 상세

승인/검토 흐름

PDF 출력

관리자(Admin)

감사 로그(AuditLog) 확장

개발 체크리스트 업데이트

핵심 신규 보완 포인트

(1) “작성자 → 검토자(제3자) → 책임자” 서명 흐름을 UI 수준에서 명확히 노출

실제 전자연구노트 운영은 단순히 올리고 끝이 아니라,
① WRITER가 실험 기록(파일+메타)을 남기고
② REVIEWER(검토자)가 “이 기록은 그 시점에 실제 존재했다”라고 확인(전자서명)하고
③ OWNER(책임자)가 최종 승인한다는 3단 구조를 강조한다. 
youtube.com
+1

이 흐름을 WECar UI에서 “승인 대기”, “검토 완료”, “최종 승인 완료”로 시각화한다.

이미 v1.6에 REVIEWER 역할과 /notes/<id>/approve API가 있지만, 이를 좀 더 Stage 기반(대기/검토됨/승인됨)으로 명확히 관리하도록 강화한다.

(2) “기록시각(자동)”과 “실험일(사용자 기입)”을 분리해서 항상 보여줄 것

전자연구노트 제도에서는 “기록이 언제 시스템에 올라갔는지(자동 시각)”과 “그 실험이 실제로 언제 수행됐는지(사용자 기입)”가 모두 중요하다. 둘 다 PDF 및 UI 목록에 표시되어야 한다. 
youtube.com
+1

우리 시스템에서는 이미:

created_date = 실제 수행/실험일 (사용자 필드)

timestamp_certified_at = 서버 시점인증 시간 (자동)

보완: 파일 리스트와 PDF 인덱스에서 두 날짜를 나란히 표기하도록 명시.

(3) “장기보존 / 삭제 억제 / 사후 몰아쓰기 방지”에 대한 경고와 감시 강화

실제 현장 가이드에서 반복적으로 강조되는 “사후에 몰아서 적지 말라”, “장기보존 의무”, “삭제는 법적 리스크”를 UI에서 계속 경고하도록 요구한다. 
youtube.com
+2
동의대학교 대표
+2

관리자 대시보드에서 “최근 30일간 업로드 0건인 과제”를 경고하는 로직은 이미 v1.6에 반영했지만, 이제는 “몰아서 일괄 업로드한 패턴”도 플래그한다. 예: 하루 안에 version_number=1 파일이 20개 이상 동시에 올라간 경우 “사후 일괄 등록 의심” 알림.

(4) 반출(다운로드/PDF Export)마다 책임 귀속(워터마크 + 반출자 정보)

PDF 워터마크에는 과제명/생성일시 외에 “반출자 이메일”을 반드시 넣는다. v1.6에 이미 반출자 이메일 포함하도록 했지만, 이를 ‘모든 페이지 워터마크’에 필수라고 못박는다. 이는 유출 경로 추적을 위한 산업계 실무 관행이다. 
youtube.com
+2
동의대학교 대표
+2

(5) 시스템 무결성 증명 여지를 남길 것

영상/안내 자료에서 강조되는 전자연구노트의 신뢰성은 “위변조 방지 가능성”, “기록의 연속성”, “검토자/책임자 전자서명” 같은 요소다. 
youtube.com
+1

우리 시스템에서는 현재 AuditLog+버전관리+삭제사유+승인스냅샷으로 이를 충족하도록 설계되어 있다.

보완: AuditLog에 각 기록(파일 row)별 “해시(SHA256)” 값을 남기는 확장 포인트를 정의한다.

즉 파일 업로드 시, 업로드한 바이너리의 SHA256 해시를 meta_json에 저장한다.

PDF 출력 시 인덱스에도 “File Hash: xxxx”를 옵션으로 넣을 수 있게 한다.

해시는 사후 법적 분쟁에서 ‘이 파일이 변조되지 않았다’는 근거가 된다.

전역 보안/운영 요구사항 보강

1.1 데이터 무결성 해시 (신규 요구)

파일 업로드 시 서버가 SHA256 해시 계산.

audit_logs.meta_json.file_hash에 저장.

PDF 인덱스에도 이 해시를 노출할지 여부를 OWNER가 선택할 수 있게 한다(민감하면 숨길 수도 있도록 옵션).

이유: 향후 특허 분쟁, 연구부정 조사에서 “원본과 동일함”을 증명할 수 있게 하기 위함. 
Genspark

1.2 승인 단계(Stage) 필드 추가

research_notes에 다음 상태 필드를 둔다:

approval_stage (enum: DRAFT, REVIEWED, APPROVED)

DRAFT: WRITER들이 기록만 누적, 아직 검토자/책임자 서명 없음

REVIEWED: REVIEWER가 검토 서명 남김(제3자 확인)

APPROVED: OWNER가 최종 승인 서명 남김

/notes/<id>/approve 호출 시, 호출 주체가 REVIEWER라면 stage를 최소 REVIEWED까지 올리고, OWNER라면 APPROVED까지 올린다.

Dashboard / notes 상세 헤더에서 이 stage를 컬러 뱃지로 표시 (“검토 대기”, “검토 완료”, “최종 승인”).

이건 전자연구노트에서 “작성자-검토자(제3자)-책임자” 순서 서명 플로우를 명문화하는 요구와 동일하다. 
youtube.com
+1

1.3 몰아쓰기 탐지(사후 기록 의심)

Admin 대시보드에서 추가로 다음 지표를 계산한다:

“최근 24시간 안에 created_date(실험일)이 1주 이상 과거인 파일이 n개 이상 대량 업로드된 과제”
→ label: “사후 일괄 등록 의심”

목적: 평가/감사에서 “현장 즉시 기록”이 아니라 나중에 인위적으로 쌓은 것 아닌가? 라는 의심 포인트를 잡아준다. 실제 전자연구노트 관리기관들이 강조하는 운영 품질 관리에 맞춘다. 
youtube.com
+1

1.4 장기보존 고지

삭제/노트삭제 모달에서 이미 경고를 띄우지만, 여기에 추가 문구를 명시한다:

“전자연구노트는 장기간(수년~수십 년) 보존 의무가 있으며, 부주의한 삭제는 정부과제 감사, 특허 분쟁 시 불리하게 작용할 수 있습니다.” 
동의대학교 대표
+1

페이지별 추가 요구/개선

2.1 로그인/회원가입 (/auth) 개선

회원가입 후 status='pending' 사용자에게 “관리자 승인 전까지 로그인 불가” 안내 화면 제공 (별도 /auth/pending 페이지).

로그인 실패(비번 틀림, suspended, pending)는 모두 AuditLog("USER_LOGIN_DENIED",{reason}).

로그인 폼 하단에 “이 시스템은 연구활동의 법적 증빙 기록 시스템입니다. 허위 기록 / 계정 공유 / 무단 반출은 감사 대상입니다.” 경고 배너 추가.
→ 실제 전자연구노트 안내에서 ‘책임 추적 가능성’을 사용자에게 초기에 분명히 알린다. 
youtube.com
+1

2.2 대시보드 (/dashboard) 개선

각 연구과제 카드에 approval_stage 뱃지:

DRAFT: “기록 중(검토 전)”

REVIEWED: “검토자 확인 완료”

APPROVED: “책임자 최종 승인”

“주의 알림” 영역 확장:

“내가 OWNER인 과제 중 APPROVED가 아닌 과제 수”

“내가 REVIEWER인 과제 중 REVIEW 요청 대기 수”

“내가 WRITER인 과제 중 아직 REVIEWED 단계까지 안 간 과제 수 (검토 요청 필요)”

다운로드 한도 경고:

“오늘 n회 다운로드 / 한도 m회 / 초과 시 차단 및 감사 대상”

이건 반출 리스크 인식을 사용자에게 상시로 심어준다. 
동의대학교 대표
+1

2.3 연구과제 생성 (/notes/new) 개선

Step3(참여자 권한)에서 Reviewer 지정 시 안내문 추가:

“REVIEWER는 제3자 검토자입니다. REVIEWER 서명은 이 기록이 해당 시점에 존재했다는 사실을 증명하는 중요한 법적 요소입니다.”

“REVIEWER가 없으면 승인 단계는 OWNER의 최종 승인만으로 진행됩니다(법적 신뢰도는 다소 낮아질 수 있음).” 
youtube.com
+1

생성 시 approval_stage 기본값은 DRAFT.

2.4 연구과제 상세 (/notes/<id>) 개선
추가로 UI/기능 요구:

[A] 상단 헤더

approval_stage를 큰 배지로 노출.

DRAFT → 노란색 “검토 대기”

REVIEWED → 파란색 “검토자 확인 완료”

APPROVED → 초록색 “최종 승인”

OWNER / REVIEWER 각각의 최신 서명 일시를 표시.

버튼 [검토자 승인 요청] :

Reviewer에게 모달을 띄워 “현재까지 업로드된 기록이 사실인지 검토 후 서명해 주세요” 라는 메시지를 보이도록 한다.

이 요청 자체도 AuditLog("REVIEWER_REQUEST",{note_id,requester_id,requested_to})로 남긴다.
(신규 action_type)

[B] 파일 업로드 모달

필수 필드 재확인:

created_date (실험 실제 수행일, 달력 선택)

short_desc (실험 목적/조건/장비 핵심)

자동 필드 readonly:

서버 업로드 시각(uploaded_at)

timestamp_certified_at (시점인증)

(신규) file_hash (SHA256) 미리보기 (고급정보 표시, 필요시 “세부 보기” 토글)

“이 정보는 PDF로 제출될 수 있으며 위·변조 감시 대상입니다.” 안내문.

[C] 파일 리스트

날짜 영역을 두 줄로 분리해서 명확하게:

“실험일(사용자입력): 2025-10-20”

“기록시각(시스템): 2025-10-21 14:32:10 KST”

version_number 옆에 [새 버전] 버튼.

삭제를 누르면 “삭제 사유(reason)” 텍스트 영역 필수 입력.

Tooltip: “삭제는 복구 불가하며 AuditLog에 영구 기록됩니다. 장기 보존 의무를 위반하면 책임 문제가 될 수 있습니다.” 
동의대학교 대표
+1

[D] 활동 로그 탭

action_type별 컬러 라벨:

FILE_UPLOAD / FILE_VERSION_UP → 기록 유지(파랑)

FILE_DELETE → 주의(빨강)

REVIEWER_APPROVE / NOTE_TRANSFER_OWNER → 관리 이벤트(보라)

각 로그 항목에 “by [사용자이름/이메일] at [시각]” + meta_json 핵심:

예: FILE_VERSION_UP → “사유: 시험 조건 업데이트(전압 변경)”

예: FILE_DELETE → “사유: 중복촬영/개인식별정보 포함”

Reviewer 승인(REVIEWER_APPROVE)이 찍힌 시점은 approval_stage 전환과 함께 강조.

2.5 승인/검토 플로우 (/notes/<id>/approve) 개선

승인/검토 모달에서:

본인 전자서명 이미지 미리보기

“현재 시각을 서명시각으로 기록하고 AuditLog에 남습니다. 이후 변경 불가능합니다. 계속할까요?” 경고

OWNER일 경우: “이 승인으로 과제는 APPROVED 상태가 됩니다. 제출용 PDF는 책임자 승인본으로 간주됩니다.”

REVIEWER일 경우: “이 검토로 과제는 REVIEWED 상태가 됩니다. 제3자 확인 흔적이 PDF에 포함됩니다.”

POST /notes/<id>/approve 동작:

approver가 REVIEWER:

approval_stage = max(current_stage, REVIEWED)

approver가 OWNER:

approval_stage = APPROVED

AuditLog("REVIEWER_APPROVE",{approver_role, signed_at, stage_after})

Dashboard와 notes 상세 헤더에서 즉시 반영.

2.6 PDF 출력 (/notes/<id>/export/pdf) 개선

PDF 워터마크(모든 페이지 상단 or 대각선 배경):

“WECar 연구개발일지 / {과제명} / 기밀 / 무단배포금지 / {PDF생성일시} / 반출자:{current_user.email}”

파일 인덱스 표에서 날짜 2개를 모두 표기:

실험일(created_date)

기록시각(timestamp_certified_at)

(선택) file_hash(해시) 컬럼 표시 여부:

OWNER가 export 요청 시 “무결성 해시 포함” 체크박스 → true면 해시 열을 노출

결재(서명) 영역:

REVIEWER 섹션(있을 경우):

이름, 소속, 전자서명 이미지, 검토일시

문구: “본인은 명시된 시점에 본 연구 데이터가 존재했음을 확인합니다.”

OWNER 섹션:

이름, 직함/소속, 전자서명 이미지, 최종 승인일시

문구: “본인은 본 연구개발일지 내용이 해당 기간에 실제 수행된 결과임을 확인하며, 그 진실성과 성실성을 보증합니다.”

PDF 출력 성공 시:

download_history INSERT(download_type="PDF_EXPORT")

AuditLog("NOTE_PDF_EXPORT",{note_id, exported_by, approval_stage})

approval_stage가 DRAFT 상태인데도 PDF를 요청한 경우 경고:

“이 문서는 아직 최종 승인되지 않았습니다(DRAFT). 외부 제출 전 책임자 확인 필요.”

이 정보도 PDF 첫 장에 ‘주의’ 블록으로 들어가게 할 수 있음.
(이는 실제 기관에서 “승인 전 출력본은 임시 자료”라는 워터마크/주의문을 넣는 것과 유사한 흐름. 
youtube.com
+2
동의대학교 대표
+2
)

2.7 관리자(Admin) 개선

/admin 대시보드:

기존 항목 + “사후 일괄 등록 의심” 리스트:

기준 예시:

최근 24시간에 업로드된 파일 중 created_date(실험일)가 14일 이상 과거인 항목이 20건 이상인 노트는 의심 표시

표시: 과제명 / Owner / 의심 건수 / 마지막 업로드 시각

목적: 형식적 사후 작성 방지(실제 전자연구노트 운영 가이드에서 강조되는 포인트). 
youtube.com
+1

/admin/notes 상세:

approval_stage 표시(DRAFT/REVIEWED/APPROVED)

REVIEWER 지정 여부 + 마지막 REVIEWER_APPROVE 일시

“Reviewer 없음” 또는 “Reviewer 지정됐지만 REVIEWER_APPROVE 없음”에 경고

/admin/downloads:

반출 로그 외에, 특정 사용자별 “반출자 이메일이 PDF 워터마크에 삽입된다”는 정책 안내 문구를 관리자 화면에도 명시

관리자는 이걸 통해 “이 PDF가 유출됐으면 누가 뽑았는지 바로 알 수 있음”을 인지한다.

감사 로그(AuditLog) 확장

신규/보완 action_type:

REVIEWER_REQUEST

OWNER 또는 NOTE OWNER가 Reviewer에게 승인 요청을 보냈을 때

meta_json: {requester_id, reviewer_id, note_id}

REVIEWER_APPROVE (강화)

meta_json: {approver_role:'REVIEWER'|'OWNER', signed_at, stage_after}

FILE_UPLOAD (강화)

meta_json: {created_date, timestamp_certified_at, short_desc, file_hash}

FILE_VERSION_UP (강화)

meta_json: {old_version, new_version, change_reason, file_hash}

NOTE_PDF_EXPORT (강화)

meta_json: {note_id, exported_by, approval_stage, include_hashes:true|false}

이렇게 meta_json 안에 해시(file_hash)나 approval_stage 등을 남기면,
나중에 분쟁/감사 시 “그 시점 시스템 상태 그대로”를 재구성할 수 있다는 점이 전자연구노트의 신뢰 포인트다. 
Genspark

개발 체크리스트 업데이트

Cursor 구현 시 다음 사항 반영이 필요합니다:

[모델 수정]

research_notes.approval_stage (enum/string: DRAFT/REVIEWED/APPROVED)

audit_logs.meta_json에 file_hash, approval_stage 등 다양한 키가 들어갈 수 있게 JSONB 유지

files 업로드 로직에서 SHA256 해시 계산 코드 추가

[Blueprint 수정]

notes.py

POST /notes/<id>/approve:

역할에 따라 approval_stage 변경

REVIEWER_REQUEST (POST /notes/<id>/request-reviewer) 같은 엔드포인트도 추가 가능

GET /notes/<id>:

approval_stage, 마지막 REVIEWER_APPROVE 시각, 마지막 OWNER APPROVE 시각 노출

files.py

/folders/<folder_id>/files 업로드 시 해시 계산 후 AuditLog에 포함

/files/<file_id>/new-version 동일

export.py

/notes/<id>/export/pdf:

워터마크에 반출자 이메일 추가

approval_stage 확인 후 DRAFT이면 PDF에 “임시/미승인본” 경고 블록

옵션으로 file_hash 컬럼 포함

admin.py

/admin:

“사후 일괄 등록 의심” 통계 계산

/admin/notes:

approval_stage, Reviewer 상태, REVIEWER_APPROVE 유무 표시

[템플릿 수정]

dashboard.html:

approval_stage 뱃지

다운로드 한도 / 반출 책임 경고

note_detail.html:

approval_stage 큰 상태 배지

파일 리스트에서 “실험일 vs 기록시각”을 분리 표기

삭제/버전업 모달에 사유 필수 입력

Reviewer 승인 요청/승인 모달 UI

export_pdf.html:

워터마크(과제명/반출자/시각)

승인/검토 서명 영역 2단(Reviewer/Owner)

created_date + timestamp_certified_at 모두 표기

(선택) file_hash 컬럼

DRAFT일 때 첫 페이지 상단에 “이 문서는 아직 최종 승인되지 않은 초안입니다” 경고 블록

[JS 개선]

approve.js:

승인/검토 모달에서 최종 경고 후 /notes/<id>/approve POST

응답으로 stage_after 받아서 화면 즉시 업데이트

upload.js:

업로드 시 created_date, short_desc 필수 확인

서버 응답으로 timestamp_certified_at, file_hash 받아서 UI에 즉시 반영

delete_confirm.js:

삭제 사유 입력 없으면 submit 불가

reorder_folders.js:

기존 그대로 (order_index 유지)

[운영 안내 노출]

/help 업데이트:

“작성자는 즉시 기록하고, 검토자(REVIEWER)는 확인 서명하고, 책임자(OWNER)는 최종 승인합니다.
이 서명 흐름은 나중에 당신의 연구가 진짜였음을 증명하는 핵심입니다.”

“PDF에는 당신(다운로드한 계정)의 이메일이 워터마크로 박혀서 외부 유출 시 추적이 가능합니다. 무단 배포는 감사 대상입니다.”

“장기 보존 대상입니다. 삭제는 법적 리스크가 될 수 있습니다.”

요약

이 v1.7 보완안은 실제 전자연구노트 가이드/시연에서 강조되는 다음 요구사항을 WECar 시스템에 반영/강화했습니다:

기록자 → 검토자(REVIEWER) → 책임자(OWNER)의 서명/승인 단계를 시스템 상태(approval_stage)로 명확히 모델링하고 UI에 표시. 
youtube.com
+1

실험일(created_date)과 기록시각(timestamp_certified_at)을 항상 병기해 “언제 수행 vs 언제 기록”을 투명하게 남김. 
youtube.com
+1

파일별 SHA256 해시를 감사로그에 남겨 위변조 방지 근거 확보. 
Genspark

PDF 워터마크에 과제명·생성시각·반출자 이메일을 모든 페이지에 주입해 반출 추적성을 극대화. 
동의대학교 대표
+1

관리자(Admin)에게 사후 몰아쓰기 의심·검토 미이행·대량 반출 등 운영 리스크를 가시화해 compliance 수준을 끌어올림. 
youtube.com
+1