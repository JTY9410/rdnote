{% extends "base.html" %}

{% block title %}감사 로그 - WECar 연구개발일지{% endblock %}

{% block content %}
{% include "admin/nav.html" %}
<h2 class="mb-4">
    <i class="bi bi-file-earmark-text"></i> 감사 로그
</h2>

<div class="card mb-4">
    <div class="card-header">
        <h5>필터</h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="from_date" class="form-label">시작일</label>
                <input type="date" class="form-control" id="from_date" name="from_date" value="{{ request.args.get('from_date', '') }}">
            </div>
            <div class="col-md-3">
                <label for="to_date" class="form-label">종료일</label>
                <input type="date" class="form-control" id="to_date" name="to_date" value="{{ request.args.get('to_date', '') }}">
            </div>
            <div class="col-md-3">
                <label for="action_type" class="form-label">액션 타입</label>
                <input type="text" class="form-control" id="action_type" name="action_type" value="{{ request.args.get('action_type', '') }}">
            </div>
            <div class="col-md-3">
                <label for="user_email" class="form-label">사용자 이메일</label>
                <input type="email" class="form-control" id="user_email" name="user_email" value="{{ request.args.get('user_email', '') }}">
            </div>
            <div class="col-md-3">
                <label for="note_id" class="form-label">연구과제 ID</label>
                <input type="number" class="form-control" id="note_id" name="note_id" value="{{ request.args.get('note_id', '') }}">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> 필터 적용</button>
                <a href="{{ url_for('admin.audit') }}" class="btn btn-secondary"><i class="bi bi-arrow-counterclockwise"></i> 초기화</a>
                <a href="{{ url_for('admin.audit_csv', **request.args) }}" class="btn btn-success"><i class="bi bi-download"></i> CSV Export</a>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>시간</th>
                <th>사용자</th>
                <th>액션</th>
                <th>상세</th>
                <th>연구과제 ID</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                    {% if log.user %}
                        <i class="bi bi-person"></i> {{ log.user.name }}
                        <br><small class="text-muted">{{ log.user.email }}</small>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-{{ 'danger' if log.action_type.startswith('ADMIN') else 'primary' if 'LOGIN' in log.action_type or 'REGISTER' in log.action_type else 'success' if 'UPLOAD' in log.action_type else 'warning' if 'DELETE' in log.action_type else 'info' }}">
                        {{ log.action_type }}
                    </span>
                </td>
                <td>
                    {% if log.meta_json %}
                        <small>{{ log.meta_json }}</small>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if log.note_id %}
                        <span class="badge bg-secondary">Note #{{ log.note_id }}</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

